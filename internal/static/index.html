<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Stash-VR</title>
    <link href="icon.png" rel="icon" type="image/png"/>
</head>
<style>
    .handle {
        cursor: grab;
        user-select: none;
        padding: 2px 6px;
        display: inline-block;
    }

    summary {
        cursor: pointer;
    }

    tr.dragging {
        opacity: 0.6;
    }

    .coverOk {
        display: none
    }

    .coverErr {
        display: none
    }
</style>
<body>
<h1><img src="icon.png" style="vertical-align: middle;">Stash-VR</h1>
<samp>
    <table>
        <tr>
            <td>Stash-VR version</td>
            <td>{{.Version}}</td>
        </tr>
        <tr>
            <td>Log level</td>
            <td>{{.LogLevel}}</td>
        </tr>
        <tr>
            <td>Force HTTPS</td>
            <td>{{.ForceHTTPS}}</td>
        </tr>
        <tr>
            <td>Stash GraphQL</td>
            <td>
                {{if eq .Redact nil}}
                {{.StashGraphQLUrl}}
                {{else}}
                <details>
                    <summary>{{call .Redact .StashGraphQLUrl}}</summary>
                    {{.StashGraphQLUrl}}
                </details>
                {{end}}
            </td>
        </tr>
        <tr>
            <td>API Key provided</td>
            <td>{{.IsApiKeyProvided}}</td>
        </tr>
        <tr>
            <td>Stash-VR → Stash</td>
            <td>
                {{if eq .StashConnectionResponse "OK"}}
                <span style="background: lime">{{.StashConnectionResponse}}</span>
                {{else if eq .StashConnectionResponse "UNAUTHORIZED"}}
                <span style="background: orange">Failed authorization: Verify that the correct Stash API Key is provided</span>
                {{else}}
                <span style="background: red">Network error: Verify that the provided Stash GraphQL url is correct and can be reached from Stash-VR</span>
                {{end}}
            </td>
        </tr>
        {{if not (eq .StashData nil)}}
        <tr>
            <td>Stash version</td>
            <td>{{.StashData.Version}}</td>
        </tr>
        <tr>
            <td>Scene Filters</td>
            <td>
                <details>
                    <summary>{{len .StashData.FilterData}} found</summary>
                    <table>
                        <tr>
                            <th>Id</th>
                            <th>Name</th>
                        </tr>
                        {{range $filter := .StashData.FilterData}}
                        <tr>
                            <td>{{$filter.Id}}</td>
                            <td>{{$filter.Name}}</td>
                        </tr>
                        {{end}}
                    </table>
                </details>
            </td>
        </tr>
        <tr>
            <td>Headset/Browser → Stash</td>
            <td>
                <img src="{{.StashData.SampleSceneCoverUrl}}"
                     style="width: 0; height: 0;"
                     onload="this.style.display='none';document.querySelectorAll('.coverOk').forEach(el => el.style.display='inline');"
                     onerror="this.style.display='none';document.querySelectorAll('.coverErr').forEach(el => el.style.display='inline');">
                <details class="coverErr"><summary style="background: red">Failed to reach Stash: Check your network settings and make sure <b>this headset</b> can reach Stash</summary>
                    Error fetching <a href="{{.StashData.SampleSceneCoverUrl}}">{{.StashData.SampleSceneCoverUrl}}</a>
                </details>
                <span class="coverOk" style="display: none; background: lime">OK</span>
            </td>
        </tr>
        {{end}}
        <tr>
            <td>Generated sections</td>
            <td>{{.SectionCount}}</td>
        </tr>
        <tr>
            <td>Total links</td>
            <td>{{.LinkCount}}</td>
        </tr>
        <tr>
            <td>Distinct scenes</td>
            <td>{{.SceneCount}}</td>
        </tr>

    </table>
</samp>
<main>
    {{if eq .StashConnectionResponse "OK"}}
    <div class="coverOk">
        <p>Open and bookmark one of the endpoints below in your VR player to access your library:</p>
        <ul>
            <li><a href="/heresphere">/heresphere</a></li>
            <li><a href="/deovr">/deovr</a></li>
        </ul>
    </div>
    {{end}}

    {{if not (eq .StashConnectionResponse "OK")}}
    <div>
        {{else}}
        <div class="coverErr">
            {{end}}
            <p>For troubleshooting <b>review the log output</b></p>
            {{if not (or (eq .LogLevel "debug") (eq .LogLevel "trace")) }}
            <p>Log level is set to "{{.LogLevel}}". For further details <b>rerun Stash-VR with log level "debug"</b></p>
            {{end}}
        </div>
</main>
{{if and .StashData .StashData.FilterOverrides}}
<section>
    <details>
        <summary>Configure filter overrides</summary>
        <form method="POST" action="/filters" id="filters">
            <table>
                <thead>
                <tr>
                    <th></th>
                    <th>Disable</th>
                    <th>ID</th>
                    <th>Name</th>
                </tr>
                </thead>
                <tbody id="rows">
                {{ range $i, $ov := .StashData.FilterOverrides }}
                <tr data-id="{{$i}}">
                    <td><span class="handle" draggable="true" title="Drag">≡</span></td>
                    <td><input type="checkbox" name="disabled" value="{{ $ov.ID }}" {{ if $ov.Disabled }}checked{{ end
                               }}/>
                    </td>
                    <td><samp>{{$ov.ID}}</samp><input type="hidden" name="id" value="{{ $ov.ID }}"/></td>
                    <td>
                        <input type="hidden" name="sourceName" value="{{$ov.SourceName}}"/>
                        <input name="targetName" placeholder="{{$ov.SourceName}}"
                               value='{{ if and (ne $ov.Name "") (ne $ov.Name $ov.SourceName)}}{{$ov.Name}}{{end}}'>
                    </td>
                </tr>
                {{end}}
                </tbody>
            </table>
            <button type="submit">Save</button>
        </form>
        <form method="POST" action="/filters">
            <button type="submit">Reset</button>
        </form>
    </details>

    <script>
        const tbody = document.getElementById('rows');
        let dragRow = null;

        tbody.addEventListener('dragstart', (e) => {
            const handle = e.target.closest('.handle');
            if (!handle) return;
            dragRow = handle.closest('tr');
            e.dataTransfer.effectAllowed = 'move';
            dragRow.classList.add('dragging');
        });

        tbody.addEventListener('dragend', () => {
            if (dragRow) dragRow.classList.remove('dragging');
            dragRow = null;
        });

        tbody.addEventListener('dragover', (e) => {
            if (!dragRow) return;
            e.preventDefault();
            const overRow = e.target.closest('tr');
            if (!overRow || overRow === dragRow) return;
            const rect = overRow.getBoundingClientRect();
            const before = (e.clientY - rect.top) < rect.height / 2;
            tbody.insertBefore(dragRow, before ? overRow : overRow.nextSibling);
        });
        tbody.addEventListener('drop', (e) => e.preventDefault());
    </script>
</section>
{{end}}
<footer><p><a href="https://github.com/o-fl0w/stash-vr" target="_blank">https://github.com/o-fl0w/stash-vr</a></p>
</footer>

</body>
</html>